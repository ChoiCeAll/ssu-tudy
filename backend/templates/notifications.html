<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì•Œë¦¼</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    .notification {
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 6px;
    }
    .notification a {
      text-decoration: none;
      color: #333;
      font-weight: bold;
    }
    button {
      margin: 5px 5px 0 0;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      border: none;
      background-color: #f0f0f0;
    }
    button:hover {
      opacity: 0.85;
    }
  </style>
</head>
<body>
  <h1>ğŸ“¬ ì•Œë¦¼ ëª©ë¡</h1>
  <div id="notification-list">ë¡œë”© ì¤‘...</div>

  <script>
    const userId = "{{ session['user_id'] }}";

    function loadNotifications() {
      fetch(`/notifications/${userId}`)
        .then(res => res.json())
        .then(data => {
          const container = document.getElementById('notification-list');
          container.innerHTML = '';

          if (!Array.isArray(data)) {
            container.innerHTML = '<p>' + (data.message || 'ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.') + '</p>';
            return;
          }

          data.forEach(noti => {
            const div = document.createElement('div');
            div.className = 'notification';

            const isApplication = noti.study_member_id !== null;
            let messageHtml = '';
            let actionButtons = `
              <button onclick="markAsRead(${noti.notification_id})">ğŸ“– ì½ìŒ</button>
              <button onclick="deleteNotification(${noti.notification_id})">ğŸ—‘ï¸ ì‚­ì œ</button>
            `;

            if (isApplication) {
              // ìŠ¤í„°ë”” ì‹ ì²­ ì•Œë¦¼
              messageHtml = `<p><strong>${noti.message}</strong></p>`;
              actionButtons += `
                <button onclick="handleDecision(${noti.study_member_id}, 'approve', ${noti.notification_id})">âœ… ìŠ¹ì¸</button>
                <button onclick="handleDecision(${noti.study_member_id}, 'reject', ${noti.notification_id})">âŒ ê±°ì ˆ</button>
              `;
            } else if (noti.study_id !== null) {
              // ê´€ì‹¬ í•´ì‹œíƒœê·¸ ê¸°ë°˜ ìŠ¤í„°ë”” ì•Œë¦¼ ë“±
              messageHtml = `<a href="/notifications/${noti.notification_id}/study">${noti.message}</a>`;
            } else {
              // ì¼ë°˜ ì•Œë¦¼ ë©”ì‹œì§€
              messageHtml = `<p>${noti.message}</p>`;
            }

            div.innerHTML = `
              ${messageHtml}
              <div>${actionButtons}</div>
            `;
            container.appendChild(div);
          });
        });
    }

    function markAsRead(id) {
      fetch(`/notifications/read/${id}`, { method: 'PUT' })
        .then(() => loadNotifications());
    }

    function deleteNotification(id) {
      fetch(`/notifications/${id}`, { method: 'DELETE' })
        .then(() => loadNotifications());
    }

    function handleDecision(studyMemberId, decision, notificationId) {
      fetch(`/study/application/${studyMemberId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ decision: decision })
      })
      .then(res => res.json())
      .then(data => {
        alert(data.message || 'ì²˜ë¦¬ ì™„ë£Œ');
        markAsRead(notificationId);  // âœ… ìŠ¹ì¸/ê±°ì ˆ ì‹œ ìë™ ì½ìŒ ì²˜ë¦¬
        loadNotifications();
      })
      .catch(err => {
        alert('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
        console.error(err);
      });
    }

    loadNotifications();
  </script>
</body>
</html>
