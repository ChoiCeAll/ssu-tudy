<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë§ˆì´í˜ì´ì§€</title>
  <style>
    .hashtag-item {
      display: inline-block;
      margin: 4px;
      padding: 4px 8px;
      background-color: #f0f0f0;
      border-radius: 4px;
    }
    .hashtag-item input {
      width: 100px;
    }
    .hashtag-item button {
      margin-left: 4px;
    }
  </style>
</head>
<body>
  <h2>ğŸ‘¤ ë‚´ ì •ë³´</h2>
  <button onclick="logout()" style="float:right;">ë¡œê·¸ì•„ì›ƒ</button>

  <div id="user-info" style="display:none;">
    <label>ì´ë¦„: <input id="name" /></label><br />
    <label>í•™ê³¼: <input id="major" /></label><br />
    <label>í•™ë²ˆ: <input id="student_id" /></label><br />
    <label>í•´ì‹œíƒœê·¸: 
      <input id="new-hashtag" placeholder="#AI ë“±">
      <button onclick="addHashtag()">ì¶”ê°€</button>
    </label><br />
    <div id="hashtag-container"></div>
    <button onclick="updateUserInfo()">ì •ë³´ ìˆ˜ì •í•˜ê¸°</button>
  </div>

  <hr />

  <div>
    <h3>âœ… ì°¸ì—¬ ì¤‘ì¸ ìŠ¤í„°ë””</h3>
    <ul id="joined-studies"></ul>
  </div>

  <div>
    <h3>ğŸ›  ë‚´ê°€ ìƒì„±í•œ ìŠ¤í„°ë””</h3>
    <ul id="created-studies"></ul>
  </div>

  <div>
    <h3>ğŸ’¡ ê´€ì‹¬ í•´ì‹œíƒœê·¸ ê¸°ë°˜ ì¶”ì²œ ìŠ¤í„°ë””</h3>
    <ul id="interested-studies"></ul>
  </div>

  <script>
    let userId = sessionStorage.getItem("user_id");
    let hashtagList = [];

    window.onload = () => {
      if (!userId) {
        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        window.location.href = "/";
        return;
      }
      loadUserInfo();
    };

    async function loadUserInfo() {
      try {
        const res = await fetch(`/api/mypage/${userId}`);
        if (!res.ok) throw new Error("ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨");
        const data = await res.json();

        document.getElementById('user-info').style.display = 'block';
        document.getElementById('name').value = data.name;
        document.getElementById('major').value = data.major;
        document.getElementById('student_id').value = data.student_id;

        hashtagList = (data.hashtags || "").split(',').map(tag => tag.trim()).filter(tag => tag);
        renderHashtags();

        const joinedRes = await fetch(`/api/mypage/${userId}/joined-studies`);
        const joined = await joinedRes.json();
        document.getElementById('joined-studies').innerHTML =
          joined.length === 0 ? '<li>ì—†ìŒ</li>' : joined.map(s =>
            `<li><strong>${s.title}</strong>: ${s.description}</li>`).join('');

        const createdRes = await fetch(`/api/mypage/${userId}/created-studies`);
        const created = await createdRes.json();
        document.getElementById('created-studies').innerHTML =
          created.length === 0 ? '<li>ì—†ìŒ</li>' : created.map(s =>
            `<li><strong>${s.title}</strong>: ${s.description} [${s.hashtags}]</li>`).join('');

        const interestRes = await fetch(`/api/mypage/${userId}/interested-studies`);
        const interest = await interestRes.json();
        document.getElementById('interested-studies').innerHTML =
          interest.length === 0 ? '<li>ì—†ìŒ</li>' : interest.map(s =>
            `<li><strong>${s.title}</strong>: ${s.description} [${s.hashtags}]</li>`).join('');
      } catch (err) {
        alert(err.message || "ì •ë³´ ë¡œë”© ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
      }
    }

    function renderHashtags() {
      const container = document.getElementById('hashtag-container');
      container.innerHTML = '';
      hashtagList.forEach((tag, idx) => {
        const div = document.createElement('div');
        div.className = 'hashtag-item';
        div.innerHTML = `
          <input value="${tag}" onchange="editHashtag(${idx}, this.value)">
          <button onclick="removeHashtag(${idx})">âŒ</button>
        `;
        container.appendChild(div);
      });
    }

    function addHashtag() {
      const newTag = document.getElementById('new-hashtag').value.trim();
      if (!newTag) return;
      if (hashtagList.includes(newTag)) {
        alert("ì´ë¯¸ ì¶”ê°€ëœ í•´ì‹œíƒœê·¸ì…ë‹ˆë‹¤.");
        return;
      }
      hashtagList.push(newTag);
      document.getElementById('new-hashtag').value = '';
      renderHashtags();
    }

    function removeHashtag(index) {
      hashtagList.splice(index, 1);
      renderHashtags();
    }

    function editHashtag(index, newValue) {
      hashtagList[index] = newValue.trim();
    }

    async function updateUserInfo() {
      const payload = {
        name: document.getElementById('name').value,
        major: document.getElementById('major').value,
        student_id: document.getElementById('student_id').value,
        hashtags: hashtagList.join(',')
      };

      const res = await fetch(`/api/mypage/${userId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const result = await res.json();
      alert(result.message || result.error || "ìˆ˜ì • ì‹¤íŒ¨");
    }

    async function logout() {
      sessionStorage.clear();
      await fetch('/logout');
      window.location.href = '/';
    }
  </script>
</body>
</html>
